- name: Create systemd service file
  template:
    src: notes-app.service.j2
    dest: /etc/systemd/system/{{ systemd_service_name }}.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - Reload systemd
    - Restart notes-app

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- block:
    - name: Enable notes-app service
      systemd:
        name: "{{ systemd_service_name }}"
        enabled: yes

    - name: Start notes-app service
      systemd:
        name: "{{ systemd_service_name }}"
        state: started

    - name: Wait for application to be ready
      wait_for:
        port: "{{ app_port }}"
        delay: 5
        timeout: 60

  rescue:
    - name: Show service status
      shell: systemctl status {{ systemd_service_name }} --no-pager
      register: service_status
      changed_when: false

    - debug:
        var: service_status.stdout_lines

    - name: Show recent logs
      shell: journalctl -u {{ systemd_service_name }} -n 80 --no-pager
      register: service_logs
      changed_when: false

    - debug:
        var: service_logs.stdout_lines

    - name: Fail deployment if service failed
      fail:
        msg: "notes-app service failed to start."
