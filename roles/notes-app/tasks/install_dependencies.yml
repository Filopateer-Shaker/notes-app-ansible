- name: Detect Linux distribution
  debug:
    msg: "Detected OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"

- name: Update system packages (DNF-based systems)
  dnf:
    name: '*'
    state: latest
    update_cache: yes
  when: ansible_pkg_mgr == "dnf"
  tags: [updates]

- name: Install required packages for Amazon Linux 2023
  dnf:
    name: "{{ required_packages }}"
    state: present
  when:
    - ansible_distribution == "Amazon"
    - ansible_distribution_major_version == "2023"
  register: amazon_packages
  retries: 3
  delay: 5
  until: amazon_packages is succeeded

- name: Install required packages for RHEL 10
  dnf:
    name: "{{ required_packages_rhel }}"
    state: present
  when:
    - ansible_distribution == "RedHat"
    - ansible_distribution_major_version == "10"

- name: Start and enable MariaDB service
  systemd:
    name: mariadb
    state: started
    enabled: yes

- name: Start and enable firewalld
  systemd:
    name: firewalld
    state: started
    enabled: yes

- name: Configure firewall for application port
  firewalld:
    port: "{{ app_port }}/tcp"
    permanent: yes
    state: enabled
    immediate: yes

- name: Install Python pip packages on target servers
  pip:
    name:
      - PyMySQL
      - cryptography
    state: present
    executable: pip3
